<section class="py-24 bg-[var(--background)] border-t border-[var(--border)] relative overflow-hidden reveal" id="features">
    <!-- Subtle accent glow -->
    <div class="absolute -top-24 -left-24 w-96 h-96 bg-[var(--accent)] opacity-[0.02] blur-[100px] rounded-full pointer-events-none"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col md:flex-row md:items-end justify-between mb-12 gap-6 animate-fade-in">
            <div class="max-w-xl">
                <div class="flex items-center gap-3 mb-3">
                    <span class="text-[var(--accent)] text-xs font-bold uppercase tracking-widest block">Developer Tooling</span>
                    <span class="px-2 py-0.5 rounded-full bg-[var(--accent)]/10 text-[var(--accent)] text-[9px] font-bold uppercase tracking-tighter border border-[var(--accent)]/20 animate-pulse">Live Demo</span>
                </div>
                <h2 class="text-4xl font-extrabold mb-4 text-[var(--text-main)]">No-Code API Builder</h2>
                <p class="text-[var(--text-muted)]">Rapidly prototype and test queries with our visual request generator. Copy the code into your environment when ready.</p>
            </div>
            <div class="flex gap-2">
                <button class="px-4 py-2 text-xs font-bold bg-[var(--background)] border border-[var(--border)] rounded text-[var(--text-main)] hover:bg-[var(--surface)] hover:border-[var(--accent)] transition-all flex items-center gap-2 shadow-sm active:scale-95">
                    <span class="material-symbols-outlined text-sm">history</span> History
                </button>
                <button class="px-4 py-2 text-xs font-bold bg-[var(--background)] border border-[var(--border)] rounded text-[var(--text-main)] hover:bg-[var(--surface)] hover:border-[var(--accent)] transition-all flex items-center gap-2 shadow-sm active:scale-95">
                    <span class="material-symbols-outlined text-sm">save</span> Presets
                </button>
            </div>
        </div>
        <div class="grid lg:grid-cols-12 gap-8 items-start relative">
            <div class="lg:col-span-4 animate-slide-up">
                <div id="ft-form-card" class="bg-[var(--surface)] p-8 rounded-xl border border-[var(--border)] flex flex-col card-lift relative z-10">
                    <div class="space-y-6 flex-grow">
                        <div>
                            <label class="block text-[11px] font-bold text-[var(--text-muted)] uppercase tracking-wider mb-2">Instrument Symbol</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                                    <span class="material-symbols-outlined text-sm">search</span>
                                </span>
                                <input id="ft-symbol" class="block w-full pl-9 border-[var(--border)] bg-[var(--background)] text-[var(--text-main)] rounded-lg text-sm focus:ring-[var(--accent)] focus:border-[var(--accent)] py-2.5 outline-none transition-all" placeholder="Search Ticker..." type="text" value="AAPL"/>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[11px] font-bold text-[var(--text-muted)] uppercase tracking-wider mb-2">Start Date</label>
                                <input id="ft-start" class="w-full border-[var(--border)] bg-[var(--background)] text-[var(--text-main)] rounded-lg text-xs focus:ring-[var(--accent)] focus:border-[var(--accent)] py-2.5 px-3 outline-none transition-all" type="date" value="2024-01-01"/>
                            </div>
                            <div>
                                <label class="block text-[11px] font-bold text-[var(--text-muted)] uppercase tracking-wider mb-2">End Date</label>
                                <input id="ft-end" class="w-full border-[var(--border)] bg-[var(--background)] text-[var(--text-main)] rounded-lg text-xs focus:ring-[var(--accent)] focus:border-[var(--accent)] py-2.5 px-3 outline-none transition-all" type="date" value="2024-05-20"/>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[11px] font-bold text-[var(--text-muted)] uppercase tracking-wider mb-2">Interval</label>
                                <select id="ft-interval" class="w-full border-[var(--border)] bg-[var(--background)] text-[var(--text-main)] rounded-lg text-xs focus:ring-[var(--accent)] focus:border-[var(--accent)] py-2.5 outline-none transition-all">
                                    <option value="tick">Tick</option>
                                    <option value="1min">1 Min</option>
                                    <option value="5min" selected="">5 Min</option>
                                    <option value="daily">Daily</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[11px] font-bold text-[var(--text-muted)] uppercase tracking-wider mb-2">Format</label>
                                <select id="ft-format" class="w-full border-[var(--border)] bg-[var(--background)] text-[var(--text-main)] rounded-lg text-xs focus:ring-[var(--accent)] focus:border-[var(--accent)] py-2.5 outline-none transition-all">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                    <option value="parquet">Parquet</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button id="run-query" class="w-full mt-8 py-3.5 bg-[var(--accent)] text-[var(--on-accent)] font-bold rounded-lg flex items-center justify-center gap-2 text-sm shadow-xl shadow-[var(--accent)]/10 hover:opacity-90 transition-all active:scale-95 group relative overflow-hidden">
                        <span class="btn-text flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">bolt</span> Run Query
                        </span>
                        <span class="btn-loader hidden flex items-center gap-2">
                             <svg class="animate-spin h-5 w-5 text-[var(--on-accent)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Optimizing...
                        </span>
                    </button>
                </div>
            </div>
            <div class="lg:col-span-8 animate-slide-up [animation-delay:200ms] self-stretch relative">
                <div class="bg-[#0B1222] rounded-xl border border-[var(--border)] overflow-hidden absolute inset-0 flex flex-col shadow-lg">
                    <div class="flex items-center px-4 py-2 border-b border-[var(--border)]/50 bg-[#111A2E]">
                        <div class="flex gap-1 mr-6" id="code-tabs">
                            <button data-lang="curl" class="tab-btn px-3 py-1.5 text-[10px] font-bold uppercase tracking-widest text-white border-b-2 border-[var(--accent)] transition-all">cURL</button>
                            <button data-lang="nodejs" class="tab-btn px-3 py-1.5 text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-slate-300 border-b-2 border-transparent transition-all">Node.js</button>
                            <button data-lang="python" class="tab-btn px-3 py-1.5 text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-slate-300 border-b-2 border-transparent transition-all">Python</button>
                        </div>
                        <div class="ml-auto flex items-center gap-3">
                            <span class="text-[10px] font-mono text-emerald-500">200 OK â€” 142ms</span>
                            <button id="copy-code" class="p-1.5 text-slate-500 hover:text-white transition-colors active:scale-90">
                                <span class="material-symbols-outlined text-[18px]">content_copy</span>
                            </button>
                        </div>
                    </div>
                    <div class="p-8 font-mono text-xs overflow-y-auto scrollbar-hide flex-grow bg-[#0B1222] relative min-h-0">
                        <!-- Content that can scroll if form is shorter than code -->
                        <!-- cURL Snippet -->
                        <div id="curl-snippet" class="code-snippet text-slate-400 opacity-100 transition-all duration-300 transform translate-x-0">
                            <span class="text-blue-400">curl</span> --request GET \<br/>
                            &nbsp;&nbsp;--url <span class="text-orange-300">'https://api.quantdata.io/v2/market/bars'</span> \<br/>
                            &nbsp;&nbsp;--header <span class="text-orange-300">'Authorization: Bearer KEY'</span> \<br/>
                            &nbsp;&nbsp;--data-urlencode <span class="text-orange-300">'symbol=<span id="curl-val-symbol">AAPL</span>'</span> \<br/>
                            &nbsp;&nbsp;--data-urlencode <span class="text-orange-300">'start=<span id="curl-val-start">2024-01-01</span>'</span> \<br/>
                            &nbsp;&nbsp;--data-urlencode <span class="text-orange-300">'end=<span id="curl-val-end">2024-05-20</span>'</span> \<br/>
                            &nbsp;&nbsp;--data-urlencode <span class="text-orange-300">'interval=<span id="curl-val-interval">5min</span>'</span>
                        </div>
                        
                        <!-- Node.js Snippet -->
                        <div id="nodejs-snippet" class="code-snippet text-slate-400 hidden opacity-0 transition-all duration-300 transform translate-x-4">
                            <span class="text-blue-400">const</span> axios = <span class="text-emerald-400">require</span>(<span class="text-orange-300">'axios'</span>);<br/><br/>
                            <span class="text-blue-400">const</span> options = {<br/>
                            &nbsp;&nbsp;method: <span class="text-orange-300">'GET'</span>,<br/>
                            &nbsp;&nbsp;url: <span class="text-orange-300">'https://api.quantdata.io/v2/market/bars'</span>,<br/>
                            &nbsp;&nbsp;params: { <span class="text-slate-300">symbol</span>: <span class="text-orange-300">'<span id="node-val-symbol">AAPL</span>'</span>, <span class="text-slate-300">interval</span>: <span class="text-orange-300">'<span id="node-val-interval">5min</span>'</span> },<br/>
                            &nbsp;&nbsp;headers: { <span class="text-slate-300">Authorization</span>: <span class="text-orange-300">'Bearer KEY'</span> }<br/>
                            };<br/><br/>
                            <span class="text-emerald-400">axios</span>.<span class="text-blue-400">request</span>(options).<span class="text-blue-400">then</span>(<span class="text-blue-400">function</span> (response) {<br/>
                            &nbsp;&nbsp;<span class="text-slate-300">console</span>.<span class="text-blue-400">log</span>(response.data);<br/>
                            });
                        </div>

                        <!-- Python Snippet -->
                        <div id="python-snippet" class="code-snippet text-slate-400 hidden opacity-0 transition-all duration-300 transform translate-x-4">
                            <span class="text-blue-400">import</span> requests<br/><br/>
                            <span class="text-slate-300">url</span> = <span class="text-orange-300">"https://api.quantdata.io/v2/market/bars"</span><br/>
                            <span class="text-slate-300">params</span> = {<br/>
                            &nbsp;&nbsp;<span class="text-orange-300">"symbol"</span>: <span class="text-orange-300">"<span id="py-val-symbol">AAPL</span>"</span>,<br/>
                            &nbsp;&nbsp;<span class="text-orange-300">"start"</span>: <span class="text-orange-300">"<span id="py-val-start">2024-01-01</span>"</span>,<br/>
                            &nbsp;&nbsp;<span class="text-orange-300">"interval"</span>: <span class="text-orange-300">"<span id="py-val-interval">5min</span>"</span><br/>
                            }<br/>
                            <span class="text-slate-300">headers</span> = {<span class="text-orange-300">"Authorization"</span>: <span class="text-orange-300">"Bearer KEY"</span>}<br/><br/>
                            <span class="text-slate-300">response</span> = requests.<span class="text-emerald-400">get</span>(url, params=params, headers=headers)<br/>
                            <span class="text-blue-400">print</span>(response.<span class="text-emerald-400">json</span>())
                        </div>

                        <div class="mt-8 border-t border-slate-800 pt-6">
                            <div class="text-slate-500 mb-4 uppercase text-[10px] font-bold tracking-[0.2em] flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                Live API Response
                            </div>
                            <div class="text-slate-300" id="live-response">
                                {<br/>
                                &nbsp;&nbsp;<span class="text-emerald-400">"status"</span>: <span class="text-orange-300">"success"</span>,<br/>
                                &nbsp;&nbsp;<span class="text-emerald-400">"data"</span>: [<br/>
                                &nbsp;&nbsp;&nbsp;&nbsp;{ <span class="text-emerald-400">"t"</span>: <span class="text-blue-400">1704114000</span>, <span class="text-emerald-400">"o"</span>: <span class="text-blue-400">192.53</span>, <span class="text-emerald-400">"h"</span>: <span class="text-blue-400">193.10</span>, <span class="text-emerald-400">"l"</span>: <span class="text-blue-400">192.40</span>, <span class="text-emerald-400">"c"</span>: <span class="text-blue-400">192.88</span> },<br/>
                                &nbsp;&nbsp;&nbsp;&nbsp;{ <span class="text-emerald-400">"t"</span>: <span class="text-blue-400">1704114300</span>, <span class="text-emerald-400">"o"</span>: <span class="text-blue-400">192.89</span>, <span class="text-emerald-400">"h"</span>: <span class="text-blue-400">192.95</span>, <span class="text-emerald-400">"l"</span>: <span class="text-blue-400">192.15</span>, <span class="text-emerald-400">"c"</span>: <span class="text-blue-400">192.42</span> }<br/>
                                &nbsp;&nbsp;]<br/>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-8 grid lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 bg-[var(--background)] border border-[var(--border)] rounded-xl overflow-hidden flex flex-col shadow-sm card-lift animate-slide-up [animation-delay:400ms]">
                <div class="px-6 py-4 border-b border-[var(--border)] flex items-center justify-between bg-[var(--surface)]">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-[var(--accent)]">show_chart</span>
                        <h4 class="text-sm font-bold uppercase tracking-wider text-[var(--text-main)]">Data Visualization</h4>
                    </div>
                    <div class="flex items-center gap-4 text-[10px] font-bold uppercase">
                        <div class="flex items-center gap-1.5 text-emerald-600">
                            <span class="w-2.5 h-2.5 bg-emerald-500 rounded-sm"></span> Bullish
                        </div>
                        <div class="flex items-center gap-1.5 text-rose-600">
                            <span class="w-2.5 h-2.5 bg-rose-500 rounded-sm"></span> Bearish
                        </div>
                    </div>
                </div>
                <div id="ft-chart-container" class="h-[500px] relative overflow-hidden bg-[var(--background)] border-b border-[var(--border)]/50">
                    <div class="absolute inset-0 grid-bg-light opacity-50 pointer-events-none"></div>
                    <div id="ft-chart-loader" class="loader-overlay active">
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
                            <p class="text-[10px] font-bold text-accent uppercase tracking-widest mt-4">Optimizing Feed...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-4 bg-[var(--surface)] border border-[var(--border)] rounded-xl p-8 flex flex-col shadow-sm card-lift animate-slide-up [animation-delay:600ms]">
                <div class="mb-8">
                    <h4 class="text-sm font-bold uppercase tracking-widest mb-2 flex items-center gap-2 text-[var(--text-main)]">
                        <span class="material-symbols-outlined text-[var(--accent)] text-xl">download</span> Export Dataset
                    </h4>
                    <p class="text-xs text-[var(--text-muted)] leading-relaxed">Download your custom query results in high-performance formats ready for production environments.</p>
                </div>
                <div class="space-y-3 mb-10">
                    {% set formats = [
                        {'name': 'CSV', 'title': 'Raw Tabular Data', 'size': '4.2 MB', 'active': true},
                        {'name': 'JSON', 'title': 'Document Object', 'size': '12.8 MB', 'active': false},
                        {'name': 'PRQ', 'title': 'Apache Parquet', 'size': '1.1 MB (Opt.)', 'active': false}
                    ] %}
                    {% for format in formats %}
                        <div class="export-format p-4 rounded-lg border-2 {% if format.active %}border-[var(--accent)]{% else %}border-[var(--border)]{% endif %} bg-[var(--background)] shadow-sm cursor-pointer group hover:border-[var(--accent)] transition-all active:scale-[0.98]">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 {% if format.active %}bg-[var(--accent)]/10 text-[var(--accent)]{% else %}bg-[var(--surface)] text-slate-400{% endif %} rounded flex items-center justify-center group-hover:bg-[var(--accent)]/10 group-hover:text-[var(--accent)] transition-colors">
                                        <span class="text-[10px] font-bold">{{ format.name }}</span>
                                    </div>
                                    <div>
                                        <div class="text-xs font-bold text-[var(--text-main)]">{{ format.title }}</div>
                                        <div class="text-[10px] text-[var(--text-muted)]">{{ format.size }}</div>
                                    </div>
                                </div>
                                <span class="check-icon material-symbols-outlined {% if format.active %}text-[var(--accent)]{% else %}text-slate-200 group-hover:text-[var(--accent)]{% endif %} transition-colors">
                                    {% if format.active %}check_circle{% else %}circle{% endif %}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button class="w-full py-4 bg-[var(--accent)] text-[var(--on-accent)] font-bold rounded-lg flex items-center justify-center gap-2 text-sm transition-opacity mt-auto hover:opacity-90 shadow-lg shadow-[var(--accent)]/10 active:scale-95">
                    Download Package <span class="material-symbols-outlined">download</span>
                </button>
            </div>
        </div>
    </div>
</section>

<style>
    .will-change-transform { will-change: transform; }
    
    /* Hide scrollbar for Chrome, Safari and Opera */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    /* Hide scrollbar for IE, Edge and Firefox */
    .scrollbar-hide {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }

    /* Loader Overlay */
    .loader-overlay {
        position: absolute;
        inset: 0;
        background: rgba(11, 18, 34, 0.8);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .loader-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    /* Make native date picker icons white in dark mode only */
    .dark input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1) brightness(100%) contrast(100%);
        cursor: pointer;
    }
</style>

<script>
    (function() {
        // --- Features Chart Logic ---
        let ftChart;
        let ftSeries;

        function initFtChart() {
            const container = document.getElementById('ft-chart-container');
            const loader = document.getElementById('ft-chart-loader');
            
            if (!container) return;
            
            if (typeof LightweightCharts === 'undefined' || ftChart) {
                if (loader && !ftChart) loader.classList.remove('active'); // Hide if lib missing
                return;
            }

            const isDark = document.documentElement.classList.contains('dark');
            ftChart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight || 400,
                layout: {
                    background: { type: 'solid', color: 'transparent' },
                    textColor: isDark ? '#A9B2C7' : '#4A5875',
                },
                grid: {
                    vertLines: { color: isDark ? '#1E2A44' : '#E2E8F0' },
                    horzLines: { color: isDark ? '#1E2A44' : '#E2E8F0' },
                },
                rightPriceScale: { borderColor: isDark ? '#1E2A44' : '#E2E8F0' },
                timeScale: { borderColor: isDark ? '#1E2A44' : '#E2E8F0' },
                autoSize: true,
            });

            ftSeries = ftChart.addCandlestickSeries({
                upColor: '#10b981',
                downColor: '#ef4444',
                borderVisible: false,
                wickUpColor: '#10b981',
                wickDownColor: '#ef4444',
            });

            window.addEventListener('resize', () => {
                if (ftChart) ftChart.applyOptions({ 
                    width: container.clientWidth,
                    height: container.clientHeight
                });
            });
        }

        async function ftFetchData() {
            const loader = document.getElementById('ft-chart-loader');
            if (loader) loader.classList.add('active');

            try {
                const symbol = document.getElementById('ft-symbol').value || 'AAPL';
                const interval = document.getElementById('ft-interval').value || '5min';
                const start = document.getElementById('ft-start').value || '2024-05-15';
                const end = document.getElementById('ft-end').value || '2024-05-20';
                const asset = 'equities'; // Default for features demo

                const url = `/api/mock/data?asset=${asset}&symbol=${symbol}&tf=${interval}&start=${start}&end=${end}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `API Error: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.status === "error") {
                    throw new Error(result.message);
                }

                const data = result.data;

                if (ftSeries && data.length > 0) ftSeries.setData(data);
                if (ftChart && data.length > 0) ftChart.timeScale().fitContent();
                
                // Update the live response display
                const resp = document.getElementById('live-response');
                if (resp) {
                    resp.innerHTML = JSON.stringify({
                        status: "success",
                        metadata: result.metadata,
                        data: data.slice(0, 2)
                    }, null, 2).replace(/\n/g, '<br/>').replace(/\s/g, '&nbsp;');
                }
            } catch (err) {
                console.error("Chart fetch error:", err);
                const resp = document.getElementById('live-response');
                if (resp) {
                    resp.innerHTML = JSON.stringify({
                        status: "error",
                        message: err.message
                    }, null, 2).replace(/\n/g, '<br/>').replace(/\s/g, '&nbsp;');
                }
                // Optional: alert(`Error: ${err.message}`);
            } finally {
                if (loader) loader.classList.remove('active');
            }
        }

        function updateCodeSnippets() {
            const vals = {
                symbol: document.getElementById('ft-symbol').value || 'AAPL',
                start: document.getElementById('ft-start').value || '2024-01-01',
                end: document.getElementById('ft-end').value || '2024-05-20',
                interval: document.getElementById('ft-interval').value || '5min',
                format: document.getElementById('ft-format').value || 'json'
            };

            // Update all placeholder spans
            const mappings = {
                'curl-val-symbol': vals.symbol,
                'curl-val-start': vals.start,
                'curl-val-end': vals.end,
                'curl-val-interval': vals.interval,
                'node-val-symbol': vals.symbol,
                'node-val-interval': vals.interval,
                'py-val-symbol': vals.symbol,
                'py-val-start': vals.start,
                'py-val-interval': vals.interval
            };

            for (const [id, val] of Object.entries(mappings)) {
                const el = document.getElementById(id);
                if (el) el.innerText = val;
            }
        }

        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        const debouncedFetch = debounce(ftFetchData, 500);

        // Add event listeners to all form inputs
        ['ft-symbol', 'ft-start', 'ft-end', 'ft-interval', 'ft-format'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', () => {
                    updateCodeSnippets();
                    if (id === 'ft-symbol') {
                        debouncedFetch();
                    }
                });
                el.addEventListener('change', () => {
                    updateCodeSnippets();
                    ftFetchData();
                });
            }
        });

        // --- Demo & Tab Logic ---
        const tabBtns = document.querySelectorAll('.tab-btn');
        const snippets = document.querySelectorAll('.code-snippet');
        
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const lang = btn.getAttribute('data-lang');
                const target = document.getElementById(`${lang}-snippet`);
                
                tabBtns.forEach(b => {
                    b.classList.replace('text-white', 'text-slate-500');
                    b.classList.replace('border-[var(--accent)]', 'border-transparent');
                });
                btn.classList.replace('text-slate-500', 'text-white');
                btn.classList.replace('border-transparent', 'border-[var(--accent)]');

                snippets.forEach(s => {
                    s.classList.add('opacity-0', 'translate-x-3');
                    setTimeout(() => s.classList.add('hidden'), 200);
                });
                
                setTimeout(() => {
                    if (target) {
                        target.classList.remove('hidden');
                        setTimeout(() => {
                            target.classList.remove('opacity-0', 'translate-x-3');
                            target.classList.add('opacity-100', 'translate-x-0');
                        }, 50);
                    }
                }, 200);
            });
        });

        const runBtn = document.getElementById('run-query');
        if (runBtn) {
            runBtn.addEventListener('click', () => {
                const text = runBtn.querySelector('.btn-text');
                const loader = runBtn.querySelector('.btn-loader');
                
                if (text) text.classList.add('hidden');
                if (loader) loader.classList.remove('hidden');
                
                ftFetchData().finally(() => {
                    if (text) text.classList.remove('hidden');
                    if (loader) loader.classList.add('hidden');
                    const resp = document.getElementById('live-response');
                    if (resp) {
                        resp.classList.add('animate-pulse', 'text-white');
                        setTimeout(() => resp.classList.remove('animate-pulse', 'text-white'), 800);
                    }
                });
            });
        }

        let demoStarted = false;
        let stopDemo = false;

        function startCodeDemo() {
            if (demoStarted) return;
            demoStarted = true;

            const symbolInput = document.getElementById('ft-symbol');
            const runBtn = document.getElementById('run-query');
            if (!symbolInput || !runBtn) return;

            tabBtns.forEach(btn => btn.addEventListener('click', () => stopDemo = true));
            runBtn.addEventListener('mousedown', () => stopDemo = true);
            symbolInput.addEventListener('mousedown', () => stopDemo = true);

            const targetSymbol = 'NVDA';
            symbolInput.value = '';
            
            let charIdx = 0;
            function typeSymbol() {
                if (stopDemo) return;
                if (charIdx < targetSymbol.length) {
                    symbolInput.value += targetSymbol[charIdx];
                    charIdx++;
                    updateCodeSnippets(); // Show syncing in real-time
                    setTimeout(typeSymbol, 150);
                } else {
                    setTimeout(() => {
                        if (!stopDemo) runBtn.click();
                    }, 500);
                }
            }
            setTimeout(typeSymbol, 500);
        }

        const demoObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    initFtChart();
                    ftFetchData(); // Trigger initial fetch to hide loader
                    setTimeout(startCodeDemo, 1000);
                    demoObserver.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 }); // Lower threshold for more reliable trigger

        const featuresSection = document.getElementById('features');
        if (featuresSection) demoObserver.observe(featuresSection);

        // Initialize snippets with current form values
        updateCodeSnippets();

        // FAILSAFE: Force hide loader after 5s if observer/init fails
        setTimeout(() => {
            const loader = document.getElementById('ft-chart-loader');
            if (loader && loader.classList.contains('active')) {
                console.warn("Failsafe: Force hiding chart loader");
                loader.classList.remove('active');
            }
        }, 5000);

        // Export Selection
        const formatCards = document.querySelectorAll('.export-format');
        formatCards.forEach(card => {
            card.addEventListener('click', () => {
                formatCards.forEach(c => {
                    c.classList.remove('border-[var(--accent)]');
                    c.classList.add('border-[var(--border)]');
                    c.querySelector('.check-icon').innerText = 'circle';
                    c.querySelector('.check-icon').classList.replace('text-[var(--accent)]', 'text-slate-200');
                });
                card.classList.add('border-[var(--accent)]');
                card.classList.remove('border-[var(--border)]');
                card.querySelector('.check-icon').innerText = 'check_circle';
                card.querySelector('.check-icon').classList.replace('text-slate-200', 'text-[var(--accent)]');
            });
        });
    })();
</script>
