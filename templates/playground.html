{% extends 'layout/base.html' %}

{% block title %}Playground | QuantDataApi - API Query Builder{% endblock %}

{% block head %}
<style type="text/tailwindcss">
    .grid-bg-light {
        background-image: radial-gradient(circle at 2px 2px, #E2E8F0 1px, transparent 0);
        background-size: 40px 40px;
    }
    .dark .grid-bg-light {
        background-image: radial-gradient(circle at 2px 2px, #334155 1px, transparent 0);
    }
    /* Hide global scroll during playground session for app-like fee */
    body {
        overflow: hidden;
    }
    /* Custom scrollbar hiding utility */
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
    /* Make native date picker icons white in dark mode only */
    .dark input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1) brightness(100%) contrast(100%);
        cursor: pointer;
    }

    .loader-overlay {
        position: absolute;
        inset: 0;
        background: rgba(var(--background-rgb, 255, 255, 255), 0.7);
        backdrop-filter: blur(2px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    .loader-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }
</style>
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row h-[calc(100vh-64px)] overflow-hidden">
    <!-- Sidebar: Query Builder -->
    <div class="w-full lg:w-[450px] border-r border-[var(--border)] flex flex-col bg-[var(--surface)] overflow-y-auto hide-scrollbar">
        <div class="p-6 border-b border-[var(--border)]">
            <h1 class="text-xl font-extrabold text-[var(--text-main)] tracking-tight">API Query Builder</h1>
            <p class="text-xs text-[var(--text-muted)] mt-1">Configure your request and generate production-ready code.</p>
        </div>
        
        <div class="p-6 space-y-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-widest mb-2 font-mono">Asset Type</label>
                    <select id="asset-type" class="w-full bg-[var(--background)] border-[var(--border)] rounded text-sm py-2 px-3 focus:ring-accent focus:border-accent text-[var(--text-main)]">
                        <option value="equities">US Equities</option>
                        <option value="forex">Forex</option>
                        <option value="crypto">Crypto</option>
                        <option value="options">Options</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-widest mb-2 font-mono">Symbol</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-[var(--text-muted)]">
                            <span class="material-symbols-outlined text-sm">search</span>
                        </span>
                        <input id="symbol-input" class="w-full bg-[var(--background)] border-[var(--border)] rounded text-sm py-2 pl-10 focus:ring-accent focus:border-accent text-[var(--text-main)]" placeholder="e.g. NVDA" type="text" value="AAPL"/>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-widest mb-2 font-mono">Timeframe</label>
                        <select id="timeframe-select" class="w-full bg-[var(--background)] border-[var(--border)] rounded text-sm py-2 px-3 focus:ring-accent focus:border-accent text-[var(--text-main)]">
                            <option value="1min">1 Minute</option>
                            <option value="5min" selected="">5 Minutes</option>
                            <option value="15min">15 Minutes</option>
                            <option value="daily">Daily</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-widest mb-2 font-mono">Format</label>
                        <select id="format-select" class="w-full bg-[var(--background)] border-[var(--border)] rounded text-sm py-2 px-3 focus:ring-accent focus:border-accent text-[var(--text-main)]">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-widest mb-2 font-mono">Start Date</label>
                        <input id="start-date" class="w-full bg-[var(--background)] border-[var(--border)] rounded text-xs py-2 px-3 focus:ring-accent focus:border-accent text-[var(--text-main)]" type="date" value="2024-05-15"/>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-widest mb-2 font-mono">End Date</label>
                        <input id="end-date" class="w-full bg-[var(--background)] border-[var(--border)] rounded text-xs py-2 px-3 focus:ring-accent focus:border-accent text-[var(--text-main)]" type="date" value="2024-05-20"/>
                    </div>
                </div>
            </div>
            
            <button id="execute-btn" class="w-full py-3 bg-accent text-[var(--on-accent)] font-bold rounded text-xs uppercase tracking-widest hover:bg-opacity-90 transition-all shadow-md flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-sm">play_arrow</span> Execute Query
            </button>
        </div>
        
        <!-- Code Export Section -->
        <div class="mt-auto border-t border-[var(--border)] bg-[var(--background)]">
            <div class="flex items-center px-4 py-2 border-b border-[var(--border)]">
                <div class="flex gap-4" id="lang-tabs">
                    <button class="lang-tab text-[10px] font-bold uppercase tracking-widest text-accent border-b-2 border-accent pb-1" data-lang="python">Python</button>
                    <button class="lang-tab text-[10px] font-bold uppercase tracking-widest text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors" data-lang="nodejs">Node.js</button>
                    <button class="lang-tab text-[10px] font-bold uppercase tracking-widest text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors" data-lang="curl">cURL</button>
                </div>
                <button id="copy-code-btn" class="ml-auto p-1 text-[var(--text-muted)] hover:text-accent transition-colors">
                    <span class="material-symbols-outlined text-sm">content_copy</span>
                </button>
            </div>
            <div id="code-content" class="p-6 bg-slate-950 text-slate-300 font-mono text-[11px] leading-relaxed overflow-x-auto min-h-[200px]">
                <!-- Python (Default) -->
                <div id="lang-python" class="lang-content">
                    <div class="flex gap-2">
                        <span class="text-indigo-400">import</span> 
                        <span>quantdata_api</span>
                        <span class="text-indigo-400">as</span>
                        <span>qd</span>
                    </div>
                    <br/>
                    <div>
                        <span class="text-slate-400">client = qd.Client(api_key=</span><span class="text-emerald-400">'YOUR_KEY'</span><span class="text-slate-400">)</span>
                    </div>
                    <div>data = client.get_bars(</div>
                    <div class="pl-4">
                        <span class="text-indigo-300">symbol</span>=<span class="text-emerald-400" id="py-symbol">'AAPL'</span>,
                    </div>
                    <div class="pl-4">
                        <span class="text-indigo-300">timeframe</span>=<span class="text-emerald-400" id="py-timeframe">'5Min'</span>,
                    </div>
                    <div class="pl-4">
                        <span class="text-indigo-300">start</span>=<span class="text-emerald-400" id="py-start">'2024-05-15'</span>,
                    </div>
                    <div class="pl-4">
                        <span class="text-indigo-300">limit</span>=<span class="text-emerald-400">100</span>
                    </div>
                    <div>)</div>
                </div>

                <!-- Node.js -->
                <div id="lang-nodejs" class="lang-content hidden">
                    <div class="flex gap-2">
                        <span class="text-indigo-400">const</span> 
                        <span>qd</span>
                        <span class="text-slate-400">=</span>
                        <span class="text-indigo-400">require</span>(
                        <span class="text-emerald-400">'quantdata-api'</span>);
                    </div>
                    <br/>
                    <div>
                        <span class="text-indigo-400">const</span>
                        <span class="text-slate-400">client =</span>
                        <span class="text-indigo-400">new</span>
                        <span class="text-slate-300">qd.Client</span>(<span class="text-emerald-400">'YOUR_KEY'</span>);
                    </div>
                    <br/>
                    <div>
                        <span class="text-indigo-400">const</span> 
                        <span class="text-slate-300">data =</span>
                        <span class="text-indigo-400">await</span>
                        <span class="text-slate-300">client.getBars</span>({
                    </div>
                    <div class="pl-4">
                        <span class="text-slate-300">symbol:</span>
                        <span class="text-emerald-400" id="js-symbol">'AAPL'</span>,
                    </div>
                    <div class="pl-4">
                        <span class="text-slate-300">timeframe:</span>
                        <span class="text-emerald-400" id="js-timeframe">'5Min'</span>,
                    </div>
                    <div class="pl-4">
                        <span class="text-slate-300">start:</span>
                        <span class="text-emerald-400" id="js-start">'2024-05-15'</span>
                    </div>
                    <div>});</div>
                </div>

                <!-- cURL -->
                <div id="lang-curl" class="lang-content hidden">
                    <div class="flex gap-2">
                        <span class="text-indigo-400">curl</span>
                        <span class="text-slate-400">-X</span>
                        <span class="text-slate-300">GET</span>
                        <span class="text-emerald-400">"https://api.quantdata.com/v1/bars"</span>
                        <span class="text-slate-400">\</span>
                    </div>
                    <div class="pl-4">
                        <span class="text-slate-400">-H</span>
                        <span class="text-emerald-400">"X-API-KEY: YOUR_KEY"</span>
                        <span class="text-slate-400">\</span>
                    </div>
                    <div class="pl-4">
                        <span class="text-slate-400">-d</span>
                        <span class="text-emerald-400" id="curl-symbol">"symbol=AAPL"</span>
                        <span class="text-slate-400">\</span>
                    </div>
                    <div class="pl-4">
                        <span class="text-slate-400">-d</span>
                        <span class="text-emerald-400" id="curl-timeframe">"timeframe=5Min"</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Visualizer Area -->
    <div class="flex-grow flex flex-col bg-[var(--background)] overflow-hidden">
        <!-- Candlestick Chart Area -->
        <div class="h-1/2 border-b border-[var(--border)] relative flex flex-col">
            <div id="chart-loader" class="loader-overlay">
                <div class="flex flex-col items-center">
                    <div class="w-8 h-8 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-[10px] font-bold text-accent uppercase tracking-widest mt-4">Fetching Market Data...</p>
                </div>
            </div>

            <div class="px-6 py-3 border-b border-[var(--border)] flex items-center justify-between bg-[var(--surface)]/50">
                <div class="flex items-center gap-4">
                    <span id="chart-title" class="text-xs font-bold uppercase tracking-wider text-[var(--text-main)]">AAPL / USD — 5m</span>
                    <span id="chart-change" class="text-xs text-emerald-500 font-bold bg-emerald-50 dark:bg-emerald-950/30 px-2 py-0.5 rounded">+1.24%</span>
                </div>
                <div class="flex items-center gap-4 text-[10px] font-bold text-[var(--text-muted)]">
                    <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 bg-emerald-500 rounded-sm"></span> OHLC</span>
                    <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 bg-slate-400 rounded-sm"></span> Volume</span>
                </div>
            </div>
            
            <div id="chart-container" class="flex-grow relative bg-[var(--background)] grid-bg-light">
                <!-- Lightweight Chart will be injected here -->
            </div>
        </div>

        <!-- Output Area: Toggle between Table and JSON -->
        <div class="h-1/2 flex flex-col bg-[var(--background)] overflow-hidden">
            <div class="px-6 py-3 border-b border-[var(--border)] flex items-center justify-between bg-[var(--surface)]/50">
                <div class="flex gap-6">
                    <button class="output-tab text-[10px] font-bold uppercase tracking-widest text-accent border-b-2 border-accent pb-1" data-target="table">Tabular Output</button>
                    <button class="output-tab text-[10px] font-bold uppercase tracking-widest text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors" data-target="json">JSON Response</button>
                </div>
                <button class="px-3 py-1 bg-white dark:bg-slate-800 border border-[var(--border)] rounded text-[10px] font-bold text-accent hover:text-[var(--on-accent)] hover:bg-accent transition-all flex items-center gap-1 shadow-sm">
                    <span class="material-symbols-outlined text-sm">download</span> Export
                </button>
            </div>
            
            <!-- Table Container -->
            <div id="output-table-container" class="flex-grow overflow-auto custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-[var(--surface)] border-b border-[var(--border)] z-10">
                        <tr>
                            <th class="px-6 py-3 text-[10px] font-bold uppercase tracking-wider text-[var(--text-muted)] font-mono">Date</th>
                            <th class="px-6 py-3 text-[10px] font-bold uppercase tracking-wider text-[var(--text-muted)] font-mono">Open</th>
                            <th class="px-6 py-3 text-[10px] font-bold uppercase tracking-wider text-[var(--text-muted)] font-mono">High</th>
                            <th class="px-6 py-3 text-[10px] font-bold uppercase tracking-wider text-[var(--text-muted)] font-mono">Low</th>
                            <th class="px-6 py-3 text-[10px] font-bold uppercase tracking-wider text-[var(--text-muted)] font-mono">Close</th>
                            <th class="px-6 py-3 text-[10px] font-bold uppercase tracking-wider text-[var(--text-muted)] font-mono">Volume</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="text-xs font-mono divide-y divide-[var(--border)] text-[var(--text-main)]">
                        <!-- Table rows will be injected here -->
                    </tbody>
                </table>
            </div>

            <!-- JSON Container -->
            <div id="output-json-container" class="hidden flex-grow overflow-auto p-6 bg-[var(--background)] font-mono text-[11px]">
                <pre id="json-output" class="text-[var(--text-main)]"></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer %}
<!-- Compact Footer for App Feel -->
<footer class="bg-[var(--background)] border-t border-[var(--border)] h-12 flex items-center px-6">
    <div class="max-w-full w-full mx-auto flex justify-between items-center">
        <div class="flex gap-6 text-[10px] font-bold uppercase tracking-widest text-[var(--text-muted)]">
            <a class="hover:text-accent transition-colors" href="#">Terms</a>
            <a class="hover:text-accent transition-colors" href="#">Privacy</a>
            <a class="hover:text-accent transition-colors" href="#">API Status</a>
        </div>
        <div class="flex items-center gap-4">
            <span class="flex items-center gap-1.5 text-[9px] font-bold text-emerald-500 uppercase">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                System Operational
            </span>
            <p class="text-[10px] font-medium text-[var(--text-muted)]">© 2024 QuantDataApi</p>
        </div>
    </div>
</footer>
{% endblock %}

{% block scripts %}
<!-- Load Lightweight Charts via CDN with specific version for stability -->
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script>
    // --- State Management ---
    let chart;
    let candlestickSeries;
    let volumeSeries;
    let currentData = [];

    const elements = {
        assetType: document.getElementById('asset-type'),
        symbol: document.getElementById('symbol-input'),
        timeframe: document.getElementById('timeframe-select'),
        start: document.getElementById('start-date'),
        end: document.getElementById('end-date'),
        executeBtn: document.getElementById('execute-btn'),
        chartLoader: document.getElementById('chart-loader'),
        chartTitle: document.getElementById('chart-title'),
        chartChange: document.getElementById('chart-change'),
        tableBody: document.getElementById('data-table-body'),
        jsonOutput: document.getElementById('json-output'),
        tabs: document.querySelectorAll('.lang-tab'),
        contents: document.querySelectorAll('.lang-content'),
        outputTabs: document.querySelectorAll('.output-tab'),
        tableContainer: document.getElementById('output-table-container'),
        jsonContainer: document.getElementById('output-json-container'),
        // Snippet placeholders
        pySymbol: document.getElementById('py-symbol'),
        pyTimeframe: document.getElementById('py-timeframe'),
        pyStart: document.getElementById('py-start'),
        jsSymbol: document.getElementById('js-symbol'),
        jsTimeframe: document.getElementById('js-timeframe'),
        jsStart: document.getElementById('js-start'),
        curlSymbol: document.getElementById('curl-symbol'),
        curlTimeframe: document.getElementById('curl-timeframe'),
    };

    // --- Chart Initialization ---
    function initChart() {
        const container = document.getElementById('chart-container');
        if (!container) return;
        
        const isDark = document.documentElement.classList.contains('dark');
        
        try {
            // Check if library is loaded
            if (typeof LightweightCharts === 'undefined') {
                console.error('LightweightCharts library not loaded');
                return;
            }

            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth || 800,
                height: container.clientHeight || 400,
                layout: {
                    background: { type: 'solid', color: 'transparent' },
                    textColor: isDark ? '#A9B2C7' : '#4A5875',
                },
                grid: {
                    vertLines: { color: isDark ? '#1E2A44' : '#E2E8F0' },
                    horzLines: { color: isDark ? '#1E2A44' : '#E2E8F0' },
                },
                rightPriceScale: {
                    borderColor: isDark ? '#1E2A44' : '#E2E8F0',
                },
                timeScale: {
                    borderColor: isDark ? '#1E2A44' : '#E2E8F0',
                    timeVisible: true,
                    secondsVisible: false,
                },
                autoSize: true, // v4 feature
            });

            // Re-verify the chart object has the expected methods
            if (typeof chart.addCandlestickSeries !== 'function') {
                console.warn('addCandlestickSeries not found on chart instance, trying fallback...');
                // Fallback for some bundle types
                if (typeof chart.addSeries === 'function') {
                    candlestickSeries = chart.addSeries(LightweightCharts.SeriesType.Candlestick);
                }
            } else {
                candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#10b981',
                    downColor: '#ef4444',
                    borderVisible: false,
                    wickUpColor: '#10b981',
                    wickDownColor: '#ef4444',
                });
            }

            if (typeof chart.addHistogramSeries === 'function') {
                volumeSeries = chart.addHistogramSeries({
                    color: '#94a3b8',
                    priceFormat: { type: 'volume' },
                    priceScaleId: '', 
                });

                volumeSeries.priceScale().applyOptions({
                    scaleMargins: { top: 0.8, bottom: 0 },
                });
            }

            window.addEventListener('resize', () => {
                if (chart) chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
            });

            // Sync with Theme Changes
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === 'class' && chart) {
                        const isDark = document.documentElement.classList.contains('dark');
                        chart.applyOptions({
                            layout: { textColor: isDark ? '#A9B2C7' : '#4A5875' },
                            grid: {
                                vertLines: { color: isDark ? '#1E2A44' : '#E2E8F0' },
                                horzLines: { color: isDark ? '#1E2A44' : '#E2E8F0' },
                            },
                        });
                    }
                });
            });
            observer.observe(document.documentElement, { attributes: true });

        } catch (err) {
            console.error('Failed to initialize chart:', err);
        }
    }

    // --- Mock Data Generator ---
    function generateMockData(symbol, timeframe, start, end) {
        const data = [];
        let startTime = new Date(start).getTime() / 1000;
        let endTime = new Date(end).getTime() / 1000;
        
        // Safety for invalid dates
        if (isNaN(startTime)) startTime = (Date.now() / 1000) - 86400 * 5;
        if (isNaN(endTime)) endTime = Date.now() / 1000;

        let lastPrice = 150 + Math.random() * 100;
        const steps = timeframe === 'daily' ? 86400 : 300; 

        let time = startTime;
        while (time < endTime + 86400) {
            const open = lastPrice;
            const close = open + (Math.random() - 0.5) * 4;
            const high = Math.max(open, close) + Math.random() * 2;
            const low = Math.min(open, close) - Math.random() * 2;
            const volume = Math.floor(Math.random() * 1000000);

            data.push({
                time: time,
                open: parseFloat(open.toFixed(2)),
                high: parseFloat(high.toFixed(2)),
                low: parseFloat(low.toFixed(2)),
                close: parseFloat(close.toFixed(2)),
                volume: volume
            });

            lastPrice = close;
            time += steps;
            if (data.length > 300) break; 
        }
        return data;
    }

    // --- Data Fetching Logic ---
    async function fetchData() {
        if (elements.chartLoader) elements.chartLoader.classList.add('active');
        
        try {
            const assetType = elements.assetType ? elements.assetType.value : 'equities';
            const symbol = (elements.symbol && elements.symbol.value) || 'AAPL';
            const timeframe = (elements.timeframe && elements.timeframe.value) || '5min';
            const start = (elements.start && elements.start.value) || '2024-05-15';
            const end = (elements.end && elements.end.value) || '2024-05-20';

            // --- BACKEND INTEGRATION POINT ---
            const url = `/api/mock/data?asset=${assetType}&symbol=${symbol}&tf=${timeframe}&start=${start}&end=${end}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `API Error: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.status === "error") {
                throw new Error(result.message);
            }
            
            currentData = result.data; 
            // ---------------------------------

            // Update Chart
            if (candlestickSeries && currentData.length > 0) {
                candlestickSeries.setData(currentData.map(d => ({
                    time: d.time,
                    open: d.open,
                    high: d.high,
                    low: d.low,
                    close: d.close
                })));
            }

            if (volumeSeries && currentData.length > 0) {
                volumeSeries.setData(currentData.map(d => ({
                    time: d.time,
                    value: d.volume,
                    color: d.close >= d.open ? '#10b98144' : '#ef444444'
                })));
            }

            if (chart && currentData.length > 0) {
                chart.timeScale().fitContent();
            }

            // Update UI Info
            if (elements.chartTitle) elements.chartTitle.textContent = `${symbol} / USD — ${timeframe}`;
            if (currentData.length > 0) {
                const last = currentData[currentData.length - 1];
                const first = currentData[0];
                const change = ((last.close - first.open) / first.open * 100).toFixed(2);
                if (elements.chartChange) {
                    elements.chartChange.textContent = `${change > 0 ? '+' : ''}${change}%`;
                    elements.chartChange.className = `text-xs font-bold px-2 py-0.5 rounded ${parseFloat(change) >= 0 ? 'text-emerald-500 bg-emerald-50 dark:bg-emerald-950/30' : 'text-rose-500 bg-rose-50 dark:bg-rose-950/30'}`;
                }
            }

            // Update Table
            if (elements.tableBody) {
                elements.tableBody.innerHTML = currentData.slice(-20).reverse().map(d => `
                    <tr class="hover:bg-[var(--surface)] transition-colors">
                        <td class="px-6 py-3 whitespace-nowrap text-[var(--text-muted)]">${new Date(d.time * 1000).toISOString().slice(0, 16).replace('T', ' ')}</td>
                        <td class="px-6 py-3">${d.open.toFixed(2)}</td>
                        <td class="px-6 py-3 text-emerald-500 font-bold">${d.high.toFixed(2)}</td>
                        <td class="px-6 py-3 text-rose-500">${d.low.toFixed(2)}</td>
                        <td class="px-6 py-3 font-extrabold text-[var(--text-main)]">${d.close.toFixed(2)}</td>
                        <td class="px-6 py-3 text-[var(--text-muted)]">${d.volume.toLocaleString()}</td>
                    </tr>
                `).join('');
            }

            // Update JSON
            if (elements.jsonOutput) {
                elements.jsonOutput.textContent = JSON.stringify({
                    status: "success",
                    metadata: { symbol, timeframe, start, count: currentData.length },
                    data: currentData.slice(-5)
                }, null, 4);
            }

        } catch (err) {
            console.error('Error fetching/updating data:', err);
            // Show error in JSON output or as an alert
            if (elements.jsonOutput) {
                elements.jsonOutput.textContent = JSON.stringify({
                    status: "error",
                    message: err.message
                }, null, 4);
            }
            // Optional: Add a small toast or alert in the UI
            alert(`Error: ${err.message}`);
        } finally {
            if (elements.chartLoader) elements.chartLoader.classList.remove('active');
        }
    }

    // --- Snippet Synchronization ---
    function updateSnippets() {
        const symbol = (elements.symbol && elements.symbol.value) || 'AAPL';
        const timeframe = (elements.timeframe && elements.timeframe.value) || '5min';
        const start = (elements.start && elements.start.value) || '2024-05-15';

        const tfMap = { '1min': '1Min', '5min': '5Min', '15min': '15Min', 'daily': 'Daily' };
        const tf = tfMap[timeframe] || '5Min';

        if (elements.pySymbol) elements.pySymbol.textContent = `'${symbol}'`;
        if (elements.pyTimeframe) elements.pyTimeframe.textContent = `'${tf}'`;
        if (elements.pyStart) elements.pyStart.textContent = `'${start}'`;

        if (elements.jsSymbol) elements.jsSymbol.textContent = `'${symbol}'`;
        if (elements.jsTimeframe) elements.jsTimeframe.textContent = `'${tf}'`;
        if (elements.jsStart) elements.jsStart.textContent = `'${start}'`;

        if (elements.curlSymbol) elements.curlSymbol.textContent = `"symbol=${symbol}"`;
        if (elements.curlTimeframe) elements.curlTimeframe.textContent = `"timeframe=${tf}"`;
    }

    // --- Event Listeners ---
    if (elements.executeBtn) elements.executeBtn.addEventListener('click', fetchData);

    // Live update snippets while typing/changing + Trigger re-fetch
    [elements.symbol, elements.timeframe, elements.start, elements.end, elements.assetType].forEach(el => {
        if (el) {
            el.addEventListener('input', updateSnippets);
            el.addEventListener('change', fetchData);
        }
    });

    // Code Tab Switching
    elements.tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetLang = tab.getAttribute('data-lang');
            elements.tabs.forEach(t => {
                t.classList.remove('text-accent', 'border-b-2', 'border-accent', 'pb-1');
                t.classList.add('text-[var(--text-muted)]');
            });
            tab.classList.remove('text-[var(--text-muted)]');
            tab.classList.add('text-accent', 'border-b-2', 'border-accent', 'pb-1');

            elements.contents.forEach(content => {
                content.classList.toggle('hidden', content.id !== `lang-${targetLang}`);
            });
        });
    });

    // Output Tab Switching
    elements.outputTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const target = tab.getAttribute('data-target');
            elements.outputTabs.forEach(t => {
                t.classList.remove('text-accent', 'border-b-2', 'border-accent', 'pb-1');
                t.classList.add('text-[var(--text-muted)]');
            });
            tab.classList.remove('text-[var(--text-muted)]');
            tab.classList.add('text-accent', 'border-b-2', 'border-accent', 'pb-1');

            if (elements.tableContainer) elements.tableContainer.classList.toggle('hidden', target !== 'table');
            if (elements.jsonContainer) elements.jsonContainer.classList.toggle('hidden', target !== 'json');
        });
    });

    // Copy Code Logic
    const copyBtn = document.getElementById('copy-code-btn');
    if (copyBtn) {
        copyBtn.addEventListener('click', () => {
            const activeContent = Array.from(elements.contents).find(c => !c.classList.contains('hidden'));
            if (activeContent) {
                navigator.clipboard.writeText(activeContent.innerText);
                const icon = copyBtn.querySelector('span');
                if (icon) {
                    const original = icon.textContent;
                    icon.textContent = 'check';
                    setTimeout(() => icon.textContent = original, 2000);
                }
            }
        });
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Delay initialization slightly to ensure all styles and fonts are ready
        setTimeout(() => {
            initChart();
            updateSnippets();
            fetchData();
        }, 100);
    });
</script>
{% endblock %}
